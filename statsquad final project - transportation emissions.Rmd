---
title: "statsquad final project - transportation emissions"
author: "Ali Sanford"
date: "April 23, 2017"
output: html_document
---

```{r setup, include=FALSE}
library(DataComputing)
library(dplyr)
library(geosphere) #contains the distance function that we used
library(ggplot2)
library(tidyr)
library(statisticalModeling)
library(RColorBrewer)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
emissionsdata <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/zipemissions.txt", fill = TRUE) #imported data obtained from UC Berkeley's CoolClimate Network. Data includes info about carbon emissions for each zip code in the US, and some identifying information about each zip code.

colnames(emissionsdata) = as.character(unlist(emissionsdata[1,])) #made the first row of the emissionsdata df into the column names
emissionsdata = emissionsdata[-1,] #deleted the first row (containing column names)

```

```{r}
emissionsdataLA1 <- emissionsdata %>% #made a Los Angeles-specific df of emissions data
  filter(CountyName == "LOSANGELES") %>% #pulled out info only for zipcodes within Los Angeles County
  select(`ZipCode`, `Population`, `HouseholdsPerZipCode`, `PersonsPerHousehold`, `AverageHouseValue`, `IncomePerHousehold`, `Latitude`, `Longitude`, `CountyName`, `popden`, `electricity(kWh)`, `Nat.Gas(cu.ft.)`, `FUELOIL(gallons)`, `Vehiclemilestraveled`, `Transport(tCO2e/yr)`) %>% #selected only variables that might be relevant to our analysis
  mutate(`Latitude` = as.numeric(paste(`Latitude`)), `Longitude` = as.numeric(paste(`Longitude`)), `IncomePerHousehold` = as.numeric(paste(`IncomePerHousehold`)), `Transport(tCO2e/yr)` = as.numeric(paste(`Transport(tCO2e/yr)`)), `AverageHouseValue` = as.numeric(paste(`AverageHouseValue`)), `Population` = as.numeric(paste(`Population`)))

emissionsdataLA1$within1km <- rep(0,nrow(emissionsdataLA1))
emissionsdataLA1$within2km <- rep(0,nrow(emissionsdataLA1))
emissionsdataLA1$within3km <- rep(0,nrow(emissionsdataLA1))

emissionsdataSF1 <- emissionsdata %>% #made a Los Angeles-specific df of emissions data
  filter(CountyName == "SANFRANCISCO") %>% #pulled out info only for zipcodes within SF County
  select(`ZipCode`, `Population`, `HouseholdsPerZipCode`, `PersonsPerHousehold`, `AverageHouseValue`, `IncomePerHousehold`, `Latitude`, `Longitude`, `CountyName`, `popden`, `electricity(kWh)`, `Nat.Gas(cu.ft.)`, `FUELOIL(gallons)`, `Vehiclemilestraveled`, `Transport(tCO2e/yr)`) %>% #selected only variables that might be relevant to our analysis
  mutate(`Latitude` = as.numeric(paste(`Latitude`)), `Longitude` = as.numeric(paste(`Longitude`)), `IncomePerHousehold` = as.numeric(paste(`IncomePerHousehold`)), `Transport(tCO2e/yr)` = as.numeric(paste(`Transport(tCO2e/yr)`)), `AverageHouseValue` = as.numeric(paste(`AverageHouseValue`)), `Population` = as.numeric(paste(`Population`)))

emissionsdataSF1$within1km <- rep(0,nrow(emissionsdataSF1))
emissionsdataSF1$within2km <- rep(0,nrow(emissionsdataSF1))
emissionsdataSF1$within3km <- rep(0,nrow(emissionsdataSF1))
```


```{r}
metrobus <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/metrobusstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
metrobus_coords <- metrobus %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon)) 

metrorail <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/metrorailstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
metrorail_coords <- metrorail %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon)) 

bigbluebus <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/bigbluebusstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
bigbluebus_coords <- bigbluebus %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon)) 

burbankbus <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/burbankbusstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
burbankbus_coords <- burbankbus %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

culvercitybus <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/culvercitystops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
culvercitybus_coords <- culvercitybus %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

dash <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/DASHstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
dash_coords <- dash %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

foothilltransit <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/foothilltransitstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
foothilltransit_coords <- foothilltransit %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

gardenatransit <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/gardenatransitstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
gardenatransit_coords <- gardenatransit %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

longbeachtransit <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/longbeachstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
longbeachtransit_coords <- longbeachtransit %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

beachbus <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/redondobeachstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
beachbus_coords <- beachbus %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

torrancetransit <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/lastops/torrancestops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
torrancetransit_coords <- torrancetransit %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))
```


```{r}
allLAstop_coords <- rbind(metrobus_coords, metrorail_coords, bigbluebus_coords, burbankbus_coords, culvercitybus_coords, dash_coords, foothilltransit_coords, gardenatransit_coords, longbeachtransit_coords, beachbus_coords, torrancetransit_coords)

allLAstop_coords_unique <- unique(allLAstop_coords)

allLAstop_coords1 <- allLAstop_coords_unique[complete.cases(allLAstop_coords_unique), ]
```


```{r}
for (i in 1:nrow(emissionsdataLA1)) {
  d1 = 0
  d2 = 0
  d3 = 0
  a <- emissionsdataLA1$Longitude[i] 
  b <- emissionsdataLA1$Latitude[i] 
  dist <- c()
  
    for (j in 1:nrow(allLAstop_coords1)) {
      e <- allLAstop_coords1$stop_lon[j]
      f <- allLAstop_coords1$stop_lat[j]
      dist[j] = distHaversine(c(a, b),
                              c(e, f))
      
      if (dist[j] < 1000) {
        d1 = d1 + 1
        d2 = d2 + 1
        d3 = d3 + 1
      } else if (dist[j] < 2000 & dist[j] > 1000) {
        d2 = d2 + 1
        d3 = d3 + 1
      } else if (dist[j] < 3000 & dist[j] > 2000) {
        d3 = d3 + 1
      }
      
    emissionsdataLA1$within1km[i] = d1
    emissionsdataLA1$within2km[i] = d2
    emissionsdataLA1$within3km[i] = d3
          }
    }
```

```{r}
bartstops <- read.csv("/Users/alisanford/Desktop/statsfinalproject/statsquad/sfstops/BARTclean.csv")
bartstop_coords <- bartstops %>%
  filter(Zipcode %in% emissionsdataSF1$ZipCode) %>%
  select(`Name`, `Latitude`, `Longitude`) %>%
  mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))

munistops <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/sfstops/munistops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
muni_coords <- munistops %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

samtransstops <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/sfstops/samtransstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
samtrans_coords <- samtransstops %>%
  filter(zone_id == 2) %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

actransitstops <- read.table("/Users/alisanford/Desktop/statsfinalproject/statsquad/sfstops/actransitstops.txt", fill=TRUE, header=TRUE, quote="", sep=",")
actransit_coords <- actransitstops %>%
  filter(stop_code %in% c("50582", "50591")) %>%
  select(`stop_name`, `stop_lat`, `stop_lon`) %>% 
  mutate(stop_lat = as.numeric(stop_lat), stop_lon = as.numeric(stop_lon))

```

```{r}
allSFstop_coords <- rbind(muni_coords, samtrans_coords, actransit_coords)
allSFstop_coords_unique <- unique(allSFstop_coords)
allSFstop_coords1 <- allSFstop_coords_unique[complete.cases(allSFstop_coords_unique), ]

```


```{r}
for (k in 1:nrow(emissionsdataSF1)) {
  z1 = 0
  z2 = 0
  z3 = 0
  v <- emissionsdataSF1$Longitude[k]
  w <- emissionsdataSF1$Latitude[k]
  dista <- c()
  
    for (l in 1:nrow(allSFstop_coords1)) {
      x <- allSFstop_coords1$stop_lon[l]
      y <- allSFstop_coords1$stop_lat[l]
      dista[l] = distHaversine(c(v, w),
                              c(x, y))
      
       if (dista[l] < 1000) {
        z1 = z1 + 1
        z2 = z2 + 1
        z3 = z3 + 1
      } else if (dista[l] < 2000 & dista[l] > 1000) {
        z2 = z2 + 1
        z3 = z3 + 1
      } else if (dista[l] < 3000 & dista[l] > 2000) {
        z3 = z3 + 1
      }
      
    emissionsdataSF1$within1km[k] = z1
    emissionsdataSF1$within2km[k] = z2
    emissionsdataSF1$within3km[k] = z3
    }
}

```


```{r}
emissionsdataLA1$incomelevels <- cut(emissionsdataLA1$IncomePerHousehold, 
                       breaks = c(-Inf, 40000, 60000, 80000, 100000, Inf), 
                       labels = c("$0-$40K", "$40K-$60K", "$60K-$80K", "$80K-$100K", "$100K+"), 
                       right = FALSE)

emissionsdataSF1$incomelevels <- cut(emissionsdataSF1$IncomePerHousehold, 
                       breaks = c(-Inf, 40000, 60000, 80000, 100000, Inf), 
                       labels = c("$0-$40K", "$40K-$60K", "$60K-$80K", "$80K-$100K", "$100K+"), 
                       right = FALSE)

LAnarrow <- emissionsdataLA1 %>%
  gather(key=distance, value=number_of_stops, `within1km`, `within2km`, `within3km` )

SFnarrow <- emissionsdataSF1 %>%
  gather(key=distance, value=number_of_stops, `within1km`, `within2km`, `within3km` )
```


```{r}
lacolortest <- emissionsdataLA1 %>%
  ggplot(aes(x = within3km, y = `Transport(tCO2e/yr)`, group = incomelevels, col = incomelevels)) + geom_point(alpha = 0.4) + stat_smooth(method = "lm", se = FALSE)
lacolortest

```

```{r}
sfcolortest <- emissionsdataSF1 %>%
  ggplot(aes(x = within1km, y = `Transport(tCO2e/yr)`, group = incomelevels, col = incomelevels)) + geom_point() + stat_smooth(method = "lm", se = FALSE)
sfcolortest

```




```{r}
laplotfaceted <- LAnarrow %>%
  ggplot(aes(x = number_of_stops, y = `Transport(tCO2e/yr)`, col = distance)) + 
  geom_point(alpha = .4) + 
  stat_smooth(method = "loess") + facet_grid(. ~ distance, switch = "both") +
  labs(title="Carbon Emissions vs Public Transit Stops - Los Angeles", x="Number of stops", y="CO2 emissions due to Transportation (tons/year)")
laplotfaceted
```


```{r}
sfplotfaceted <- SFnarrow %>%
  ggplot(aes(x = number_of_stops, y = `Transport(tCO2e/yr)`, col = distance)) + geom_point(alpha = .4) + stat_smooth(method = "loess") + facet_grid(. ~ distance, switch = "both") +
  labs(title="Carbon Emissions vs Public Transit Stops - San Francisco", x="Number of stops", y="CO2 emissions due to Transportation (tons/year)")
sfplotfaceted
```


```{r}
LAnarrow$incomelevels <- cut(emissionsdataLA1$IncomePerHousehold, 
                       breaks = c(-Inf, 40000, 60000, 80000, 100000, Inf), 
                       labels = c("1", "2", "3", "4", "5"), 
                       right = FALSE)
```

```{r}
max(emissionsdataLA1$within1km)
max(emissionsdataSF1$within1km)
```




```{r}
emissionsdataLA1$stoplevels <- cut(emissionsdataLA1$within1km, 
                       breaks = c(-Inf, 25, 50, 75, 100, 125, 150, 175, 200, Inf), 
                       labels = c("0-25", "26-50", "51-75", "76-100", "101-125", "126-150", "151-175", "176-200", "201+"), 
                       right = FALSE)

emissionsdataSF1$stoplevels <- cut(emissionsdataSF1$within1km, 
                       breaks = c(-Inf, 25, 50, 75, 100, 125, 150, 175, 200, Inf), 
                       labels = c("0-25", "26-50", "51-75", "76-100", "101-125", "126-150", "151-175", "176-200", "201+"), 
                       right = FALSE)

emissionsdataLA1$emissionlevels <- cut(emissionsdataLA1$`Transport(tCO2e/yr)`, 
                       breaks = c(-Inf, 5, 10, 15, 20, 25, 30, 35, 40, Inf), 
                       labels = c("0-5", "6-10", "11-15", "16-20", "21-25", "26-30", "31-35", "36-40", "41+"), 
                       right = FALSE)

emissionsdataSF1$emissionlevels <- cut(emissionsdataSF1$`Transport(tCO2e/yr)`, 
                       breaks = c(-Inf, 5, 10, 15, 20, 25, 30, 35, 40, Inf), 
                       labels = c("0-5", "6-10", "11-15", "16-20", "21-25", "26-30", "31-35", "36-40", "41+"), 
                       right = FALSE)
```

```{r}
ggplot(emissionsdataLA1, aes(x = incomelevels, fill = stoplevels)) +
  geom_bar(position = "fill") +
  scale_fill_brewer()
```


```{r}
ggplot(emissionsdataLA1, aes(x = stoplevels, fill = emissionlevels)) +
  geom_bar(position = "fill", alpha = 0.6) +
  scale_fill_brewer(palette = "Spectral") +
  labs(title="Number of Stops vs Emission Levels - LA", x="Number of stops within 1km", legend = "Carbon Emissions from Transportation (tons/yr)")
```

```{r}
ggplot(emissionsdataSF1, aes(x = stoplevels, fill = emissionlevels)) +
  geom_bar(position = "fill", alpha = 0.6) +
  scale_fill_brewer(palette = "Spectral") +
  labs(title="Number of Stops vs Emission Levels - SF", x="Number of stops within 1km", legend = "Carbon Emissions from Transportation (tons/yr)")
```

```{r}
laplotfaceted2 <- emissionsdataLA1 %>%
  ggplot(aes(x = within1km, y = `Transport(tCO2e/yr)`)) + 
  geom_point() + 
  stat_smooth(method = "lm", se = FALSE) + facet_grid(. ~ incomelevels)
laplotfaceted2
```

```{r}
sfplotfaceted2 <- emissionsdataSF1 %>%
  ggplot(aes(x = within1km, y = `Transport(tCO2e/yr)`)) + 
  geom_point() + 
  stat_smooth(method = "lm", se = FALSE) + facet_grid(. ~ incomelevels)
sfplotfaceted2
```

```{r}
ggplot(emissionsdataLA1, aes(x = `IncomePerHousehold`, y = `Transport(tCO2e/yr)`, group = stoplevels, color = stoplevels)) + geom_point(alpha = 0.3) + stat_smooth(method = "lm", se = FALSE)
```
```{r}
ggplot(emissionsdataSF1, aes(x = `IncomePerHousehold`, y = `Transport(tCO2e/yr)`, group = stoplevels, color = stoplevels)) + geom_point(alpha = 0.3) + stat_smooth(method = "lm", se = FALSE)
```

```{r}
ggplot(emissionsdataLA1, aes(x = Population, y = `Transport(tCO2e/yr)`)) + geom_point() + stat_smooth(method = "lm")
```

```{r}
ggplot(emissionsdataSF1, aes(x = Population, y = `Transport(tCO2e/yr)`)) + geom_point() + stat_smooth(method = "lm")
```

```{r}
laadjustedemissions <- emissionsdataLA1 %>%
  ggplot(aes(x = within3km, y = `Transport(tCO2e/yr)`/Population)) + geom_point(alpha = .2) + stat_smooth(method = "loess") + ylim(0, .01) + xlim(0, 500)
laadjustedemissions
```

```{r}

laadjustedemissions <- emissionsdataLA1 %>%
  ggplot(aes(x = within1km, y = `Transport(tCO2e/yr)`/Population)) + geom_point(alpha = .2) + stat_smooth(method = "lm") + ylim(0, .005) + xlim(0, 100)
laadjustedemissions
```

```{r}
bothcityemissionsdata <- rbind(emissionsdataLA1, emissionsdataSF1)
bothnarrow <- rbind(LAnarrow, SFnarrow)

bothplotfaceted <- bothnarrow %>%
  ggplot(aes(x = number_of_stops, y = `Transport(tCO2e/yr)`, col = distance)) + 
  geom_point(alpha = .4) + 
  stat_smooth(method = "loess") + facet_grid(CITYNAME ~ distance, switch = "both") +
  labs(title="Carbon Emissions vs Public Transit Stops - Los Angeles", x="Number of stops", y="CO2 emissions due to Transportation (tons/year)")
bothplotfaceted
```




```{r}
write.csv(LAnarrow, "/Users/alisanford/Desktop/statsfinalproject/statsquad/LAnarrow.csv")
write.csv(SFnarrow, "/Users/alisanford/Desktop/statsfinalproject/statsquad/SFnarrow.csv")
write.csv(emissionsdataLA1, "/Users/alisanford/Desktop/statsfinalproject/statsquad/emissionsdataLA1.csv")
write.csv(emissionsdataSF1, "/Users/alisanford/Desktop/statsfinalproject/statsquad/emissionsdataSF1.csv")

```








